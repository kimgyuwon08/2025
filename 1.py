import streamlit as st
import datetime as dt
import math
from dataclasses import dataclass

# =========================
# 기본 테이블
# =========================
STEMS = ["갑(甲)","을(乙)","병(丙)","정(丁)","무(戊)","기(己)","경(庚)","신(辛)","임(壬)","계(癸)"]
BRANCHES = ["자(子)","축(丑)","인(寅)","묘(卯)","진(辰)","사(巳)","오(午)","미(未)","신(申)","유(酉)","술(戌)","해(亥)"]
BRANCH_ANIMALS = ["쥐🐭","소🐮","호랑이🐯","토끼🐰","용🐲","뱀🐍","말🐴","양🐑","원숭이🐵","닭🐔","개🐶","돼지🐷"]

STEM_ELEMENT = {
    "갑(甲)":"목","을(乙)":"목","병(丙)":"화","정(丁)":"화","무(戊)":"토","기(己)":"토","경(庚)":"금","신(辛)":"금","임(壬)":"수","계(癸)":"수"
}
STEM_YINYANG = { # 양: True, 음: False
    "갑(甲)":True,"을(乙)":False,"병(丙)":True,"정(丁)":False,"무(戊)":True,"기(己)":False,"경(庚)":True,"신(辛)":False,"임(壬)":True,"계(癸)":False
}
BRANCH_ELEMENT = {
    "자(子)":"수","축(丑)":"토","인(寅)":"목","묘(卯)":"목","진(辰)":"토","사(巳)":"화",
    "오(午)":"화","미(未)":"토","신(申)":"금","유(酉)":"금","술(戌)":"토","해(亥)":"수"
}

# 월간 시작(寅月) 테이블: 해당 연간 그룹에서 寅月(1월)의 천간
# 甲·己年: 丙, 乙·庚年: 戊, 丙·辛年: 庚, 丁·壬年: 壬, 戊·癸年: 甲
MONTH_START_BY_YEAR_STEM = {
    "갑(甲)":"병(丙)","기(己)":"병(丙)",
    "을(乙)":"무(戊)","경(庚)":"무(戊)",
    "병(丙)":"경(庚)","신(辛)":"경(庚)",
    "정(丁)":"임(壬)","임(壬)":"임(壬)",
    "무(戊)":"갑(甲)","계(癸)":"갑(甲)"
}
# 寅月을 1로 두고 월지(월의 지지)는 寅→卯→... 순환
MONTH_BRANCH_SEQ = ["인(寅)","묘(卯)","진(辰)","사(巳)","오(午)","미(未)","신(申)","유(酉)","술(戌)","해(亥)","자(子)","축(丑)"]

# 도화(桃花) 규칙: 본명(일지 또는 년지)의 삼합그룹에 따른 도화지지
# 申子辰 → 酉, 亥卯未 → 子, 寅午戌 → 卯, 巳酉丑 → 午
PEACH_BLOSSOM_FOR_GROUP = {
    "신(申)자(子)진(辰)":"유(酉)",
    "해(亥)묘(卯)미(未)":"자(子)",
    "인(寅)오(午)술(戌)":"묘(卯)",
    "사(巳)유(酉)축(丑)":"오(午)"
}

@dataclass
class Pillar:
    stem: str
    branch: str

# =========================
# 보조 함수
# =========================
def lichun_year(date: dt.date) -> int:
    """입춘(간이) 기준: 2월 4일 이전이면 전년도로 간주."""
    y = date.year
    if date.month < 2 or (date.month == 2 and date.day < 4):
        return y - 1
    return y

def year_pillar_by_lichun(date: dt.date) -> Pillar:
    # 간지 주기 기준점: 1984년은 갑자(甲子)년 (양력 2/4 이후 기준)로 널리 사용됨
    # 여기서는 입춘 간이 기준으로 연간/연지 계산
    y = lichun_year(date)
    stem = STEMS[(y - 4) % 10]      # 4년이 갑(甲) 기준
    branch = BRANCHES[(y - 4) % 12] # 4년이 자(子) 기준
    return Pillar(stem, branch)

def month_pillar(date: dt.date, year_stem: str) -> Pillar:
    """
    寅月을 1로 보고(대략 2/4~3/5) 월지/월간 계산 (간이).
    실제는 절기 경계(입춘, 경칩, 청명...) 기준이지만 여기서는 월 경계 간이 근사.
    """
    # 寅月 시작 월/일을 간이로 2/4로 둔다.
    # 寅: ~
